<!-- TOC -->

- [类文件结构(.class)](#类文件结构class)
    - [魔数](#魔数)
    - [Class文件的版本号](#class文件的版本号)
    - [常量池](#常量池)
        - [常量池项目的标志和类型](#常量池项目的标志和类型)
        - [常量池的结构总体](#常量池的结构总体)
    - [访问标志](#访问标志)
    - [类索引、父类索引、接口数和接口索引集合](#类索引父类索引接口数和接口索引集合)
    - [字段表数和字段表集合](#字段表数和字段表集合)
        - [字典表结构](#字典表结构)
        - [字段标志位和含义](#字段标志位和含义)
        - [描述符标识字符含义](#描述符标识字符含义)
    - [方法表数和方法表集合](#方法表数和方法表集合)
        - [方法表结构](#方法表结构)
        - [方法访问标志](#方法访问标志)
    - [属性表集合](#属性表集合)
        - [属性表结构](#属性表结构)
    - [预定义属性](#预定义属性)

<!-- /TOC -->

# 类文件结构(.class)

Class文件是一组以**8位字节**为基础单位的二进制流，各个数据项严格按照顺序紧凑地排列在Class文件中，中间没有添加任何分隔符。

当遇到需要占用8位字节以上空间的数据项时，则会按照**大端法**的方式**分割成若干8位字节**进行存储。

Class文件格式采用一种类似于C语言结构体的伪结构来存储数据，这种伪结构中只有两种数据类型：**无符号数和表**。

**无符号数**属于基本的数据类型，以**u1、u2、u4、u8来分别代表1个字节、2个字节、4个字节和8个字节的无符号数**，无符号数可以用来描述数字、索引引用、数量值或者按照UTF-8编码构成字符串值。

表是由多个无符号数或者其他表作为数据项构成的**复合数据类型**，所有表都习惯性地以"**_info**"结尾。**表类似C语言的结构体，而不是数组。**

![image-20200521234428036](%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84.assets/image-20200521234428036.png)

## 魔数

每个Class文件的头4个字节称为魔数（Magic Number），值为0xCAFEBABE(咖啡宝贝)，它的唯一作用是确定这个文件是否为一个能被虚拟机接受的Class文件。

![image-20200521235907236](%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84.assets/image-20200521235907236.png)

## Class文件的版本号

紧接着的四个字节是Class文件的版本号，两个字节是次版本号(Minor version)，两个字节是主版本号(Major Version)。JDK能向下兼容版本号小于JDK版本的Class文件，但不能运行版本号大于JDK版本的Class文件。

## 常量池

在常量池的入口需要放置一项u2类型的数据，代表常量池容量计数值（constant_pool_count）。在常量池容量计数器之后是常量池表。

常量池容量计数器是从1开始的，索引0用来表示**不引用任何一个常量池项目**。当常量池容量计数值为22时，则说明常量池内有21个项目，索引值为1~21.

常量池中主要存放两大类常量：字面量（Literal）和符号引用（Symbolic References）。

- 字面量是Java语言层面的常量，例如文本字符串、声明为final的常量值等；
- 符号引用包括三类常量：
  - 类和接口的全限定名；(即含路径的类的全名)
  - 字段的名称和描述符；
  - 方法的名称和描述符；

> Java代码在进行Javac编译的时候，并不像C和C++那样有“连接”这一步骤，而是在虚拟机**加载Class文件**的时候进行**动态连接**。

**常量池的每一项都是个表**，在表的开头是一个u1类型的标志位。

### 常量池项目的标志和类型

![image-20200522001733305](%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84.assets/image-20200522001733305.png)

### 常量池的结构总体

![image-20200522002227341](%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84.assets/image-20200522002227341.png)

![image-20200522002233973](%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84.assets/image-20200522002233973.png)

## 访问标志

在常量池后2个字节代表访问标志（access_flag)，这个标志用于识别一些类或者接口层次的访问信息。

![image-20200522002459607](%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84.assets/image-20200522002459607.png)

## 类索引、父类索引、接口数和接口索引集合

类索引（this_class）和父类索引（super_class）都是一个u2类型的数据，而接口索引集合（interfaces）是一组u2类型的数据的集合，Class文件中由这三项数据来确定这个类的继承关系。

- 类索引查找全限定名的过程
  - ![image-20200522002909040](%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84.assets/image-20200522002909040.png)

## 字段表数和字段表集合

字段表数(fields_count)用于描述字段表的数量。

字段表（field_info）用于描述接口或者类中声明的变量。字段（field）包括类级变量以及实例级变量，但不包括在方法内部声明的局部变量。包括的信息有：字段作用域、实例变量或类变量、可变性、并发可见性、是否被序列化、字段数据类型、字段名称。

字段表集合中**不会列出从超类或者父接口中继承而来的字段**，但有可能列出原本Java代码之中不存在的字段，譬如在内部类中为了保持对外部类的访问性，会自动添加指向外部类实例的字段。

### 字典表结构

![image-20200522003300554](%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84.assets/image-20200522003300554.png)

字段修饰符放在u2类型的access_flags项目中。

### 字段标志位和含义

![image-20200522003310399](%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84.assets/image-20200522003310399.png)

字段描述符放在常量池中，字符串描述符索引放在u2类型的descriptor_index项目中。

### 描述符标识字符含义

![image-20200522003838849](%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84.assets/image-20200522003838849.png)

对数组类型，每一维度使用一个前置的'['字符描述，例如"[[Ljava/lang/String"。

字段表内可能跟随着一个属性表数和属性表集合用来描述额外信息。

## 方法表数和方法表集合

**如果父类方法在子类中没有被重写（Override），方法表集合中就不会出现来自父类的方法信息。**但同样的，有可能会出现由编译器自动添加的方法，最典型的便是类构造器"＜clinit＞"方法和实例构造器"＜init＞"方法。

### 方法表结构

![image-20200522004548160](%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84.assets/image-20200522004548160.png)

### 方法访问标志

![image-20200522004656341](%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84.assets/image-20200522004656341.png)

## 属性表集合

在Class文件、字段表和方法表中都可以携带自己的属性表集合，用以描述额外的信息。、

**属性表项目不允许与已存在的属性名重复。**

### 属性表结构

![image-20200522004941947](%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84.assets/image-20200522004941947.png)

## 预定义属性

![image-20200522004906913](%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84.assets/image-20200522004906913.png)

![image-20200522004917617](%E7%B1%BB%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84.assets/image-20200522004917617.png)

